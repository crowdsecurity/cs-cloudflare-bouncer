
systemctl daemon-reload


START=0

if [ "$1" = "configure" ]; then

    type cscli

    if [ "$?" -eq "0" ] ; then
        must_generate=$(grep -s '${API_KEY}' /etc/crowdsec/bouncers/crowdsec-cloudflare-bouncer.yaml | wc -l)
        if [ "$must_generate" -eq "1" ] ; then
            START=1
            echo "cscli/crowdsec is present, generating API key"
            unique=`date +%s`
            API_KEY=`cscli -oraw bouncers add CloudflareBouncer-${unique}`
            if [ $? -eq 1 ] ; then
                echo "failed to create API token, service won't be started."
                START=0
                API_KEY='${API_KEY}'
            else
                echo "API Key : ${API_KEY}"
            fi

            TMP=`mktemp -p /tmp/`
            cp /etc/crowdsec/bouncers/crowdsec-cloudflare-bouncer.yaml ${TMP}
            API_KEY=${API_KEY} envsubst < ${TMP} > /etc/crowdsec/bouncers/crowdsec-cloudflare-bouncer.yaml
            rm ${TMP}
        else
            echo "Not generating API key because already present"
        fi
    fi
else
    START=1
fi


echo "If this is fresh install or you've installed the package maintainer's version of configuration"
echo "Please configure '/etc/crowdsec/bouncers/crowdsec-cloudflare-bouncer.yaml'."
echo "Configuration can be autogenerated using crowdsec-cloudflare-bouncer -g <CF_TOKEN_1>,<CF_TOKEN_2> -o /etc/crowdsec/bouncers/crowdsec-cloudflare-bouncer.yaml"
echo "After configuration run the command 'systemctl start crowdsec-cloudflare-bouncer.service' to start the bouncer"

if [ ${START} -eq 0 ] ; then
    echo "no api key was generated, you can generate one on your LAPI Server by running 'cscli bouncers add <bouncer_name>' and add it to '/etc/crowdsec/bouncers/crowdsec-cloudflare-bouncer.yaml'"
fi

